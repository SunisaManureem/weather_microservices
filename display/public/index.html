<!doctype html> 
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Realtime weather dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      color-scheme: light dark;
      /* ====== THEME: DAWN (Light) ====== */
      --bg-start:#fff3e7;
      --bg-end:#f2efff;
      --ink:#0f172a;
      --muted:#6b7280;
      --border:#e6e3ef;
      --glass:rgba(255,255,255,.78);
      --glass-strong:rgba(255,255,255,.9);
      --shadow:0 24px 60px rgba(17,24,39,.08), 0 4px 16px rgba(17,24,39,.06);
      --accent:#7c3aed;
      --accent-weak:#ede9fe;

      /* === ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ === */
      --sun:#ef4444;  /* ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå: ‡πÅ‡∏î‡∏á */
      --mon:#facc15;  /* ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
      --tue:#db2777;  /* ‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£: ‡∏ä‡∏°‡∏û‡∏π */
      --wed:#22c55e;  /* ‡∏û‡∏∏‡∏ò: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
      --thu:#f97316;  /* ‡∏û‡∏§‡∏´‡∏±‡∏™: ‡∏™‡πâ‡∏° */
      --fri:#3b82f6;  /* ‡∏®‡∏∏‡∏Å‡∏£‡πå: ‡∏ü‡πâ‡∏≤ */
      --sat:#8b5cf6;  /* ‡πÄ‡∏™‡∏≤‡∏£‡πå: ‡∏°‡πà‡∏ß‡∏á */

      --stat-bg:rgba(253,253,255,.92);
      --stat-border:#ece8f8;

      --humid-bg:#ffe9f0;   --humid-border:#ffd5e3;
      --press-bg:#eefaff;   --press-border:#d7f3ff;
      --wind-bg:#f2ecff;    --wind-border:#e6dbff;

      --radius:20px;
    }

    /* ========= NIGHT ========= */
    html[data-theme="night"]{
      --bg-start:#0b1024; --bg-end:#1a1031; --ink:#e9e7ff; --muted:#b9b7d4; --border:#272344;
      --glass:rgba(22,16,45,.55); --glass-strong:rgba(22,16,45,.68);
      --shadow:0 26px 60px rgba(0,0,0,.45), 0 6px 18px rgba(0,0,0,.32);
      --accent:#a3e635; --accent-weak:rgba(163,230,53,.16);
      --stat-bg:rgba(29,22,54,.72); --stat-border:#2f2957;
    }
    html[data-theme="night"] .card h2{ color:#cfcdf0 }
    html[data-theme="night"] .stat h3{ color:#b5b2d9 }

    /* ================== Reset/Layout ================== */
    *{ box-sizing:border-box }
    *, *::before, *::after{ min-width:0 }

    html, body{
      max-width:100%;
      overflow-x:hidden;
      height:auto;
      min-height:100%;
    }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", Arial, sans-serif;
      margin:0; line-height:1.5; color:var(--ink);
      background:
        radial-gradient(1200px 520px at 85% -10%, rgba(255,188,143,.25), transparent 60%),
        radial-gradient(900px 500px at 10% 0%, rgba(186,165,255,.28), transparent 55%),
        radial-gradient(280px 220px at 20% 28%, rgba(255,255,255,.9), transparent 65%),
        linear-gradient(180deg, var(--bg-start), var(--bg-end));
      min-height:100svh;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    .sky{
      position:fixed; inset:0; pointer-events:none; opacity:.26; filter:blur(2px) contrast(105%);
      background:
        radial-gradient(180px 140px at 18% 20%, #fff, transparent 60%),
        radial-gradient(220px 160px at 78% 14%, #fff, transparent 60%),
        radial-gradient(160px 120px at 60% 28%, #fff, transparent 60%);
      z-index:-1;
    }

    .page{
      width:100%;
      max-width:1200px;
      margin: clamp(16px, 3vw, 28px) auto clamp(24px, 4vw, 48px);
      padding: 0 12px;
    }

    .topbar{
      width:100%;
      display:flex; align-items:center; gap:clamp(8px,1.8vw,14px); flex-wrap:wrap;
      padding: clamp(10px, 1.8vw, 14px) clamp(12px, 2.2vw, 18px);
      border:1px solid var(--border); border-radius:calc(var(--radius) + 6px);
      background:var(--glass-strong); backdrop-filter:saturate(140%) blur(10px);
      box-shadow:var(--shadow);
      justify-content:center; text-align:center;
    }
    h1{font-size:clamp(1.2rem, 3.2vw, 1.8rem); margin:0; letter-spacing:.3px; font-weight:900; width:100%; display:flex; justify-content:center; gap:8px}
    #curLoc{opacity:.9}
    .live{display:inline-flex; align-items:center; gap:8px; font-weight:900; color:#16a34a}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 6px rgba(34,197,94,.18);animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(.9);opacity:.6}50%{transform:scale(1);opacity:1}100%{transform:scale(.9);opacity:.6}}
    #updated{color:var(--muted);font-size:.95rem}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .seg{display:inline-flex; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:rgba(255,255,255,.86)}
    .seg button{
      padding:6px 12px;border:0;background:transparent;cursor:pointer;font-weight:900;color:#3a3a52; white-space:nowrap
    }
    .seg button.active{
      background:linear-gradient(180deg, var(--accent-weak), #ffffff);
      color:var(--accent);
    }
    html[data-theme="night"] .seg{ background:rgba(18,14,40,.7) }
    .pill{border:1px solid var(--border); border-radius:999px; padding:8px 14px; background:#fff; cursor:pointer; font-weight:800}
    select{padding:8px 12px; border:1px solid var(--border); border-radius:12px; background:#fff; font-weight:700; max-width:100%}

    .grid{ display:grid; gap:22px; grid-template-columns: 1fr; width:100% }
    section, .grid, .big{ min-width:0 }

    .card, .stat{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--glass);
      backdrop-filter:saturate(160%) blur(12px);
      box-shadow:var(--shadow);
      width:100%;
    }
    .card{ padding: clamp(12px, 2.2vw, 20px); }
    .card h2{ margin:0 0 10px 0; font-size:clamp(1rem, 2.6vw, 1.08rem); color:#4b5563; display:flex; align-items:center; gap:8px; letter-spacing:.2px }

    .big{ display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 12px; flex-direction:column }
    .temp{ font-size:clamp(3rem, 12vw, 5.6rem); font-weight:900; letter-spacing:.5px; line-height:1 }
    .icon{ font-size:clamp(2rem, 8vw, 3.2rem); filter:drop-shadow(0 6px 10px rgba(0,0,0,.08)) }

    .meta{ color:#3f3f55; display:grid; gap:6px; align-items:center; text-align:center }
    .meta small{ color:var(--muted) }

    /* ===== ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ===== */
    .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; margin-top:12px }
    .stat{
      background:var(--stat-bg);
      border-color:var(--stat-border);
      box-shadow:0 14px 32px rgba(15,23,42,.08);
      padding:14px; transition:transform .15s ease, box-shadow .15s ease
    }
    .stats .stat:nth-child(1){
      background:linear-gradient(180deg, var(--humid-bg), rgba(255,255,255,.9));
      border-color:var(--humid-border);
    }
    .stats .stat:nth-child(2){
      background:linear-gradient(180deg, var(--press-bg), rgba(255,255,255,.9));
      border-color:var(--press-border);
    }
    .stats .stat:nth-child(3){
      background:linear-gradient(180deg, var(--wind-bg), rgba(255,255,255,.9));
      border-color:var(--wind-border);
    }
    html[data-theme="night"] .stats .stat:nth-child(1),
    html[data-theme="night"] .stats .stat:nth-child(2),
    html[data-theme="night"] .stats .stat:nth-child(3){
      background:var(--stat-bg);
      border-color:var(--stat-border);
    }
    .stat:hover{ transform:translateY(-2px); box-shadow:0 22px 44px rgba(0,0,0,.12) }
    .stat h3{ margin:0; font-size:.95rem; color:#6b7280 }
    .stat .v{ font-size:clamp(1.18rem, 3.2vw, 1.48rem); font-weight:900; margin-top:8px }

    /* ===== ‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ===== */
    .hourlyRow{ display:flex; gap:12px; overflow:auto; padding:8px 2px; scroll-snap-type:x proximity; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain }
    .hourlyRow::-webkit-scrollbar{ height:8px }
    .hourlyRow::-webkit-scrollbar-thumb{ background:#d4d0e8; border-radius:999px }
    .hcard{
      flex:0 0 clamp(92px, 26vw, 112px);
      border:1px solid var(--stat-border);
      background:var(--stat-bg);
      border-radius:18px; padding:12px;
      box-shadow:var(--shadow); scroll-snap-align:start; transition:transform .15s ease, box-shadow .15s ease
    }
    .hcard:hover{ transform:translateY(-3px); box-shadow:0 18px 36px rgba(15,23,42,.12) }
    .hcard .t{ font-weight:900; color:var(--ink); font-size:.92rem; opacity:.9 }
    .hcard .i{ font-size:1.35rem; margin:8px 0 }
    .hcard .v{ font-weight:900; font-size:1.02rem }

    /* ===== ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡πÉ‡∏ä‡πâ currentColor ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) ===== */
    .weekRow{ display:flex; flex-direction:column; gap:10px; }
    .drow{
      display:grid;
      grid-template-columns: auto auto 1fr auto;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border:1px solid var(--stat-border);
      background:var(--stat-bg);
      border-radius:16px;
      box-shadow:var(--shadow);
      transition:transform .15s ease, box-shadow .15s ease;
      position:relative;
    }
    .drow:hover{ transform:translateY(-2px); box-shadow:0 18px 36px rgba(15,23,42,.12) }
    .drow::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:4px;
      border-top-left-radius:16px; border-bottom-left-radius:16px;
      background:currentColor; opacity:.9;
    }
    .drow.sun{ color:var(--sun) }
    .drow.mon{ color:var(--mon) }
    .drow.tue{ color:var(--tue) }
    .drow.wed{ color:var(--wed) }
    .drow.thu{ color:var(--thu) }
    .drow.fri{ color:var(--fri) }
    .drow.sat{ color:var(--sat) }

    .daycell{ display:flex; align-items:center; gap:10px; min-width:0; color:var(--ink) }
    .daycell .dname{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .daycell .i{ font-size:1.25rem; filter:drop-shadow(0 6px 10px rgba(0,0,0,.08)) }

    .barcell{ display:flex; align-items:center }
    .barTrack{
      position:relative; height:8px; width:100%;
      border-radius:999px; background:rgba(125,125,180,.18); overflow:hidden;
    }
    .barRange{
      position:absolute; top:0; bottom:0;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-weak), #fff);
      box-shadow: inset 0 0 0 1px rgba(124,58,237,.18);
    }
    .temps{ display:flex; align-items:center; gap:10px; font-weight:900 }
    .hi, .lo{
      display:inline-block; padding:4px 8px; border-radius:999px; font-weight:900;
      border:1px solid var(--stat-border); background:#fff;
    }
    .hi{ color:#ef4444; }
    .lo{ color:#3b82f6; }

    section .card + .card{ margin-top:14px }

    @media (max-width: 1024px){
      .stats{ gap:12px; }
    }
    @media (max-width: 768px){
      .topbar{ flex-direction: column; align-items: stretch; gap:10px; }
      .controls{ margin-left:0; width:100%; gap:8px; flex-wrap:wrap; justify-content:center }
      .stats{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px){
      .stats{ grid-template-columns: 1fr; }
      .hcard{ flex-basis: clamp(94px, 36vw, 110px); }
      .drow{ padding:10px 12px; border-radius:14px }
      .drow::before{ border-top-left-radius:14px; border-bottom-left-radius:14px }
      .daycell .dname{ max-width: 7.6em; }
    }
  </style>
</head>
<body>
  <div class="sky"></div>

  <div class="page">
    <div class="topbar">
      <h1>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® <span id="curLoc"></span></h1>
      <div class="live"><span class="dot"></span> LIVE</div>
      <div id="updated" class="muted">Loading...</div>
      <div class="controls">
        <div class="seg">
          <button id="btnC" class="active">¬∞C</button>
          <button id="btnF">¬∞F</button>
        </div>

        <div class="seg mode">
          <button id="lightBtn" class="active">Light</button>
          <button id="nightBtn">Night</button>
        </div>

        <select id="autoSel">
          <option value="0">Auto: Off</option>
          <option value="30">Every 30s</option>
          <option value="60" selected>Every 60s</option>
          <option value="300">Every 5 min</option>
        </select>
        <button id="refreshBtn" class="pill">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <section>
        <div class="card" aria-live="polite">
          <h2>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
          <div class="big">
            <div class="icon" id="wxIcon">‚õÖ</div>
            <div class="temp"><span id="curTemp">‚Äî</span></div>
          </div>
          <div class="meta">
            <div><strong>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> <span id="curSrc">‚Äî</span></div>
            <small>Note: Times shown are your local timezone</small>
          </div>

          <div class="stats">
            <div class="stat">
              <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</h3>
              <div class="v" id="curHum">‚Äî</div>
            </div>
            <div class="stat">
              <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
              <div class="v" id="curPres">‚Äî</div>
            </div>
            <div class="stat">
              <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°</h3>
              <div class="v" id="curWindBlock">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h2>
          <div id="hourlyRow" class="hourlyRow"><div class="muted">‚Äî</div></div>
        </div>

        <div class="card">
          <h2>‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
          <div id="weekRow" class="weekRow"><div class="muted">‚Äî</div></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* ====== Utilities ====== */
    const CtoF = c => (c*9/5)+32;
    const fmt  = v => isFinite(v) ? (Math.round(v*10)/10).toFixed(1) : '‚Äî';

    /* state */
    const state = { unit:'C', records:[], hourly:[], daily:[], location:'' };

    /* Clock */
    const enDT = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: true
    });
    function startClock(){
      const el = document.getElementById('updated');
      function tick(){ el.textContent = 'Updated: ' + enDT.format(new Date()); }
      tick();
      if (window._clock) clearInterval(window._clock);
      window._clock = setInterval(tick, 1000);
    }

    function iconEmoji(kind){
      if (typeof kind === 'string') {
        const k = kind.toLowerCase();
        if (k.includes('rain')) return 'üåßÔ∏è';
        if (k.includes('thunder')) return '‚õàÔ∏è';
        if (k.includes('cloud') || k.includes('partly')) return '‚õÖ';
        if (k.includes('clear') || k.includes('sun')) return '‚òÄÔ∏è';
        if (k.includes('snow')) return 'üå®Ô∏è';
        if (k.includes('wind')) return 'üí®';
        return '‚õÖ';
      }
      const n = Number(kind);
      if (Number.isFinite(n)) {
        if (n === 0) return '‚òÄÔ∏è';
        if ([1,2,3,45,48].includes(n)) return '‚õÖ';
        if ([51,53,55,61,63,65,80,81,82].includes(n)) return 'üåßÔ∏è';
        if ([71,73,75,77,85,86].includes(n)) return 'üå®Ô∏è';
        if ([95,96,99].includes(n)) return '‚õàÔ∏è';
        return '‚õÖ';
      }
      return '‚õÖ';
    }

    const curTempEl=document.getElementById('curTemp'),
          curSrcEl=document.getElementById('curSrc'),
          curHumEl=document.getElementById('curHum'),
          curPresEl=document.getElementById('curPres'),
          curWindBlockEl=document.getElementById('curWindBlock'),
          wxIconEl=document.getElementById('wxIcon'),
          curLocEl=document.getElementById('curLoc');
    const hourlyRow=document.getElementById('hourlyRow');
    const weekRow=document.getElementById('weekRow');

    function renderCurrent(){
      const latest = state.records[state.records.length-1]; if(!latest) return;
      const t = state.unit==='C' ? latest.temp : CtoF(latest.temp);
      curTempEl.textContent = fmt(t) + " ¬∞" + state.unit;
      curSrcEl.textContent  = latest.source || '‚Äî';
      curHumEl.textContent  = latest.humidity != null ? `${fmt(latest.humidity)} %` : '‚Äî';
      curPresEl.textContent = latest.pressure != null ? `${fmt(latest.pressure)} hPa` : '‚Äî';
      curWindBlockEl.textContent = latest.wind != null ? `${fmt(latest.wind)} km/h` : '‚Äî';
      wxIconEl.textContent  = iconEmoji(latest.icon);
      curLocEl.textContent  = state.location || '';
    }

    const hh = ts => { const d=new Date(ts); const h=d.getHours(); const ampm=h<12?'AM':'PM'; const h12=(h%12)||12; return `${h12} ${ampm}`; };

    /* ===== ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠‡∏ß‡∏±‡∏ô + ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô ===== */
    const LOCALE = 'th-TH';
    const TZ     = 'Asia/Bangkok';
    const dayFmt = new Intl.DateTimeFormat(LOCALE, { timeZone: TZ, weekday: 'short' });
    const dayLabel = (dstr) => {
      const d = new Date(dstr.includes('T') ? dstr : `${dstr}T00:00:00Z`);
      return dayFmt.format(d);
    };
    function weekdayClass(dateStr){
      const d = new Date(dateStr.includes('T')? dateStr : `${dateStr}T00:00:00`);
      const w = d.getDay(); // 0=Sun ... 6=Sat
      return ['sun','mon','tue','wed','thu','fri','sat'][w];
    }

    function renderHourly(){
      hourlyRow.innerHTML='';
      if(!state.hourly.length){hourlyRow.innerHTML='<div class="muted">‚Äî</div>'; return;}
      state.hourly.slice(0,12).forEach(h=>{
        const t = state.unit==='C' ? h.temp : CtoF(h.temp);
        const div=document.createElement('div');
        div.className='hcard';
        div.innerHTML=`<div class="t">${hh(h.time)}</div>
                       <div class="i">${iconEmoji(h.icon)}</div>
                       <div class="v">${fmt(t)}¬∞</div>`;
        hourlyRow.appendChild(div);
      });
    }

    /* ===== ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‚Äì ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚Äì ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏ß‡∏≤ ===== */
    function renderWeekly(){
      weekRow.innerHTML='';
      if(!state.daily.length){weekRow.innerHTML='<div class="muted">‚Äî</div>'; return;}

      const conv = (x)=> state.unit==='C' ? x : CtoF(x);
      const mins = state.daily.slice(0,7).map(d=>conv(d.min));
      const maxs = state.daily.slice(0,7).map(d=>conv(d.max));
      const gMin = Math.min(...mins);
      const gMax = Math.max(...maxs);
      const span = (gMax - gMin) || 1;

      state.daily.slice(0,7).forEach(d=>{
        const min = conv(d.min);
        const max = conv(d.max);
        const cls = weekdayClass(d.date);
        const leftPct  = ((min - gMin) / span) * 100;
        const rightPct = ((max - gMin) / span) * 100;

        const row=document.createElement('div');
        row.className=`drow ${cls}`;
        row.innerHTML = `
          <div class="daycell">
            <span class="dname">${dayLabel(d.date)}</span>
            <span class="i">${iconEmoji(d.icon)}</span>
          </div>
          <span class="lo">${fmt(min)}¬∞</span>
          <div class="barcell">
            <div class="barTrack">
              <div class="barRange" style="left:${leftPct}%; width:${Math.max(3, rightPct-leftPct)}%"></div>
            </div>
          </div>
          <span class="hi">${fmt(max)}¬∞</span>`;
        weekRow.appendChild(row);
      });
    }

    function pushRecord(d){
      let ts=d.time ?? d.timestamp;
      if(typeof ts==='number'){ if(ts<1e12) ts*=1000; ts=new Date(ts).toISOString(); }
      if (d.location) state.location = d.location;
      state.records.push({
        time:ts, temp:Number(d.temp), wind:Number(d.wind), source:d.source||'',
        humidity:d.humidity!=null?Number(d.humidity):null, pressure:d.pressure!=null?Number(d.pressure):null,
        icon:d.icon, location:d.location||''
      });
      while(state.records.length>60) state.records.shift();
    }

    async function loadCurrent(){
      const r=await fetch('/api/current',{cache:'no-store'}); if(!r.ok) throw new Error();
      const data=await r.json();
      if (data.location) state.location = data.location;
      state.records=[]; 
      pushRecord(data);
      renderCurrent();
    }

    async function loadForecast(){
      const r=await fetch('/api/forecast',{cache:'no-store'}); if(!r.ok) throw new Error();
      const f=await r.json();
      if (f.location) state.location = f.location;
      state.hourly=(f.hourly||[]).map(x=>({time:x.time,temp:Number(x.temp),icon:x.icon}));
      state.daily=(f.daily||[]).map(x=>({date:x.date,min:Number(x.min),max:Number(x.max),icon:x.icon}));
      renderHourly(); renderWeekly();
      renderCurrent();
    }

    async function withRetry(fn, tries=2, delay=300){
      let err; for(let i=0;i<tries;i++){ try{return await fn();} catch(e){err=e; await new Promise(r=>setTimeout(r,delay*(i+1)));} }
      throw err;
    }

    function connectSSE(){
      const es=new EventSource('/events');
      es.onmessage=ev=>{ try{ const d=JSON.parse(ev.data); if(!d) return; pushRecord(d); renderCurrent(); }catch{} };
      es.addEventListener('hello',()=>{loadForecast().catch(()=>{})});
      es.onopen=()=>{loadForecast().catch(()=>{})};
    }

    document.getElementById('refreshBtn').addEventListener('click',()=>{ loadCurrent().catch(()=>{}); loadForecast().catch(()=>{}); });
    document.getElementById('autoSel').addEventListener('change',e=>{
      const sec=Number(e.target.value); if(window._pullTimer) clearInterval(window._pullTimer);
      if(sec>0) window._pullTimer=setInterval(()=>{ loadCurrent().catch(()=>{}); loadForecast().catch(()=>{}) },sec*1000);
    });
    document.getElementById('btnC').addEventListener('click',()=>{ document.getElementById('btnC').classList.add('active'); document.getElementById('btnF').classList.remove('active'); state.unit='C'; renderCurrent(); renderHourly(); renderWeekly(); });
    document.getElementById('btnF').addEventListener('click',()=>{ document.getElementById('btnF').classList.add('active'); document.getElementById('btnC').classList.remove('active'); state.unit='F'; renderCurrent(); renderHourly(); renderWeekly(); });

    const THEME_KEY = 'theme';
    function applyTheme(t){
      const root = document.documentElement;
      root.setAttribute('data-theme', t);
      document.getElementById('lightBtn')?.classList.toggle('active', t==='light');
      document.getElementById('nightBtn')?.classList.toggle('active', t==='night');
      try{ localStorage.setItem(THEME_KEY, t); }catch{}
    }
    (function initTheme(){
      const saved = (()=>{ try{return localStorage.getItem(THEME_KEY);}catch{return null;} })();
      const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(saved || (systemDark ? 'night' : 'light'));
      document.getElementById('lightBtn')?.addEventListener('click', ()=>applyTheme('light'));
      document.getElementById('nightBtn')?.addEventListener('click', ()=>applyTheme('night'));
    })();

    (async()=>{
      startClock();
      await withRetry(loadCurrent,2,400).catch(()=>{});
      await withRetry(loadForecast,2,500).catch(()=>{});
      connectSSE();
      window._pullTimer=setInterval(()=>{ loadCurrent().catch(()=>{}); loadForecast().catch(()=>{}) },60*1000);
    })();
  </script>
</body>
</html>
